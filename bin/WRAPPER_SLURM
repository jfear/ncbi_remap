#!/bin/bash
#SBATCH --job-name="seq_pipeline"
#SBATCH --partition="niddk,norm"
#SBATCH --cpus-per-task=2
#SBATCH --time=120:00:00
#SBATCH --mem=3G
#SBATCH --output=../slurm_logs/slurm-%j.out
#SBATCH --error=../slurm_logs/slurm-%j.out
source activate ncbi_remap

SNAKEFILE=$1
EXTRA=$2

# Make required folders
WORKDIR=`dirname $SNAKEFILE`
if [[ ! -e $WORKDIR/slurm_logs ]]; then mkdir -p $WORKDIR/slurm_logs; fi

# run pipeline
(time snakemake \
    -p \
    --rerun-incomplete \
    --jobname "s.{rulename}.{jobid}.sh" \
    -j 800 \
    -k \
    --resources mem_gb=1
    --restart-times 4 \
    --verbose \
    --use-conda \
    --directory $WORKDIR \
    --cluster-config $WORKDIR/slurm.yml \
    --cluster "sbatch --partition {cluster.partition} --cpus-per-task {threads} --mem {resources.mem_gb}g --time {cluster.time} --gres {cluster.gres} --output=slurm_logs/${EXTRA}_{rule}.o.%j --error=slurm_logs/${EXTRA}_{rule}.e.%j" \
    --latency-wait=60 \
    -s $SNAKEFILE \
    $EXTRA \
    ) > "$WORKDIR/${EXTRA}.log" 2>&1
