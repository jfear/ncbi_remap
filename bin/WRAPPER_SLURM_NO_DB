#!/bin/bash
#SBATCH --job-name="seq_pipeline"
#SBATCH --partition="niddk,norm"
#SBATCH --cpus-per-task=4
#SBATCH --time=120:00:00
#SBATCH --mem=12G
#SBATCH --output=../output/logs/slurm-%j.out
#SBATCH --error=../output/logs/slurm-%j.out
source activate ncbi_remap

SNAKEFILE=$1
EXTRA=$2
CLUSTER=$3

# Make required folders
WORKDIR=../.`basename $SNAKEFILE .snake`
if [[ ! -e $WORKDIR/slurm_logs ]]; then mkdir -p $WORKDIR/slurm_logs; fi

# run pipeline
(time snakemake \
    -p \
    --rerun-incomplete \
    --jobname "s.{rulename}.{jobid}.sh" \
    -j 800 \
    -k \
    --verbose \
    --use-conda \
    --cluster-config $CLUSTER \
    --cluster "sbatch --partition {cluster.partition} --cpus-per-task {threads} --mem {cluster.mem} --time {cluster.time} --gres {cluster.gres} --output=slurm_logs/${SNAKEFILE}_{rule}.o.%j --error=slurm_logs/${SNAKEFILE}_{rule}.e.%j" \
    --latency-wait=60 \
    -s $SNAKEFILE \
    $EXTRA \
    ) > "$WORKDIR/${SNAKEFILE}_${EXTRA}.log" 2>&1 &

SNAKE_PID=$!

finish(){
    echo 'Stopping running snakemake job.'
    kill -SIGINT $SNAKE_PID
    exit 0
}
trap finish SIGTERM

wait $SNAKE_PID
