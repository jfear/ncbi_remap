"""Downstream analysis for RNA-Seq data.

Workflow for generating downstream files on RNA-Seq data specifically.
"""
import pandas as pd

# Setup tempdir to work with lscratch
TMPDIR = os.path.join('/lscratch', os.getenv('SLURM_JOBID'))
shell.prefix("set -euo pipefail; export TMPDIR={};".format(TMPDIR))

# Set working dir
workdir: '.'

# import config
configfile: '../config/reference_config.yaml'

patterns = {
    'bam': '../output/aln-wf/samples/{srx}/{srx}.bam',
    'stringtie': '../output/rnaseq-analysis-wf/{srx}.stringtie.gtf',
    'merged_bam': '../output/rnaseq-analysis-wf/merged.bam',
    'stringtie_merged': '../output/rnaseq-analysis-wf/merged.stringtie.gtf',
}

metadata = pd.read_parquet('../output/metadata-wf/select_library_strategy.parquet')
srxs = metadata[metadata.Fear_et_al_library_strategy.str.contains('RNA-Seq')].index.tolist()

rule targets:
    input: expand(patterns['stringtie'], srx=srxs)


rule stringTie:
    """Create Individual StringTie GTF.

    Generates a StringTie GTF for each file. Note that if coverage is low
    StringTie may not work well.
    """
    input:
        bam = '../output/aln-wf/samples/{srx}/{srx}.bam',
        gtf = config['references']['dmel']['gtf'],
    output: patterns['stringtie']
    threads: 2
    resources:
      mem_gb=lambda wildcards, attempt: attempt * 1,
      time_hr=lambda wildcards, attempt: attempt * 1
    script: 'scripts/stringtie.py'


rule mergeBam:
    """Merge a large number of bams together."""
    input: expand(patterns['bam'], srx=srxs)
    output: temp(patterns['merged_bam'])
    script: 'scripts/merge_bam.py'


rule stringTie_merged:
    """Create a StringTie GTF from a merged set of BAMs.

    This should get around any coverage issues, but differences in
    strandedness may cause problems.
    """
    input:
        bam = rules.mergeBam.output[0],
        gtf = config['references']['dmel']['gtf'],
    output: patterns['stringtie_merged']
    threads: 2
    resources:
      mem_gb=lambda wildcards, attempt: attempt * 1,
      time_hr=lambda wildcards, attempt: attempt * 1
    script: 'scripts/stringtie.py'
